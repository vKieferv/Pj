<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramientas de Trabajo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo personalizado con los colores oficiales de Papa John's */
        body {
            font-family: 'Inter', sans-serif;
        }
        .header {
            background-color: #006D56; /* Rojo vivo */
            color: white;
        }
        .btn-primary {
            background-color: #006D56; /* Verde Bangladesh */
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #005A47; /* Verde m√°s oscuro para hover */
        }
        .btn-secondary {
            background-color: #FF0017; /* Rojo vivo */
            color: white;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #D60014; /* Rojo m√°s oscuro para hover */
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 1.5rem;
            height: 100%; /* Para que las tarjetas tengan la misma altura */
        }
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            box-sizing: border-box; /* Asegura que el padding no afecte el ancho */
        }
        .output-list li {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #E5E7EB;
            font-size: 0.9rem;
        }
        .output-list li:last-child {
            border-bottom: none;
        }
        .output-list li span:first-child {
            font-weight: 600;
            color: #4B5563;
        }
        .output-list li span:last-child {
            font-weight: 700;
            color: #1F2937;
            font-size: 1rem;
        }

        /* Estilo para los botones de la barra de navegaci√≥n */
        .nav-link {
            transition: all 0.3s;
        }
    </style>
</head>
<body class="bg-gray-100">

    <header class="header p-6 shadow-md">
        <h1 class="text-3xl font-bold text-center">Herramientas de Ayuda</h1>
    </header>

    <div class="bg-white shadow-md sticky top-0 z-10">
        <nav class="flex justify-center max-w-3xl mx-auto">
            <button id="nav-link-descuentos" data-view="view-descuentos" class="nav-link flex-1 p-4 text-center font-bold text-lg" style="color: #006D56; border-bottom: 4px solid #006D56;">
                üí∏ Descuentos
            </button>
            <button id="nav-link-rotulos" data-view="view-rotulos" class="nav-link flex-1 p-4 text-center font-bold text-lg" style="color: #6B7280; border-bottom: 4px solid transparent;">
                üóìÔ∏è R√≥tulos
            </button>
            <button id="nav-link-rotulo-auto" data-view="view-rotulo-auto" class="nav-link flex-1 p-4 text-center font-bold text-lg" style="color: #6B7280; border-bottom: 4px solid transparent;">
                üè∑Ô∏è R√≥tulo Auto
            </button>
        </nav>
    </div>
    <main class="p-4 md:p-8">

        <div id="view-descuentos" class="view-content grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <div class="card">
                <h2 class="text-xl font-bold mb-4 text-gray-800">1. Calculadora de Descuentos Fijos</h2>
                <label for="basePrice" class="font-semibold text-gray-700">Precio Base (CLP):</label>
                <input type="number" id="basePrice" placeholder="Ej: 10000" class="input-field mb-4">
                
                <ul id="discountList" class="output-list bg-gray-50 rounded-lg">
                    <li><span>10% DCTO:</span> <span id="discount-10">$0</span></li>
                    <li><span>20% DCTO:</span> <span id="discount-20">$0</span></li>
                    <li><span>25% DCTO:</span> <span id="discount-25">$0</span></li>
                    <li><span>30% DCTO:</span> <span id="discount-30">$0</span></li>
                    <li><span>40% DCTO:</span> <span id="discount-40">$0</span></li>
                    <li><span>50% DCTO:</span> <span id="discount-50">$0</span></li>
                </ul>
            </div>

            <div class="card">
                <h2 class="text-xl font-bold mb-4 text-gray-800">2. Descuento sobre Descuento</h2>
                <label for="stackedPrice" class="font-semibold text-gray-700">Precio Actual (CLP):</label>
                <input type="number" id="stackedPrice" placeholder="Ej: 10000" class="input-field">
                
                <label for="stackedPercent" class="font-semibold text-gray-700 mt-4 block">Porcentaje a Aplicar (%):</label>
                <input type="number" id="stackedPercent" placeholder="Ej: 10" class="input-field mb-4">
                
                <button id="applyStacked" class="btn-secondary w-full py-3 rounded-lg font-bold text-lg">
                    Aplicar Descuento
                </button>
                
                <div class="mt-4 text-center">
                    <p class="text-gray-600 text-lg">Veces aplicado: 
                        <span id="stackedCount" class="font-bold text-2xl" style="color: #FF0017;">0</span>
                    </p>
                    <p class="text-gray-800 text-xl mt-2">Nuevo Total:</p>
                    <p id="stackedTotal" class="font-bold text-4xl text-gray-900">$0</p>
                </div>
            </div>

        </div> <div id="view-rotulos" class="view-content hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            
            <div class="card">
                <h2 class="text-xl font-bold mb-4 text-gray-800">3. Calculadora de R√≥tulos (D√≠as)</h2>
                <div class="text-center bg-blue-100 text-blue-800 p-3 rounded-lg mb-4">
                    <span class="font-semibold">Hoy es:</span>
                    <span id="todayDate" class="font-bold text-lg">--/--/----</span>
                </div>
                
                <ul id="dateList" class="output-list bg-gray-50 rounded-lg">
                    <li><span>+ 3 D√≠as:</span> <span id="date-3">--/--/----</span></li>
                    <li><span>+ 5 D√≠as:</span> <span id="date-5">--/--/----</span></li>
                    <li><span>+ 10 D√≠as:</span> <span id="date-10">--/--/----</span></li>
                    <li><span>+ 15 D√≠as:</span> <span id="date-15">--/--/----</span></li>
                    <li><span>+ 30 D√≠as:</span> <span id="date-30">--/--/----</span></li>
                </ul>

                <div class="mt-4 pt-4 border-t border-gray-200">
                    <h3 class="font-semibold text-gray-700 mb-2">Calcular D√≠as Personalizados</h3>
                    <label for="customDays" class="text-sm text-gray-600">D√≠as a a√±adir:</label>
                    <input type="number" id="customDays" placeholder="Ej: 7" class="input-field my-2">
                    <div class="text-center bg-blue-100 text-blue-800 p-3 rounded-lg mt-2">
                        <span class="font-semibold">Fecha resultante:</span>
                        <span id="customDateResult" class="font-bold text-lg">--/--/----</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="text-xl font-bold mb-4 text-gray-800">4. Calculadora de R√≥tulos (Horas)</h2>
                <div class="text-center bg-blue-100 text-blue-800 p-3 rounded-lg mb-4">
                    <span class="font-semibold">Ahora es:</span>
                    <span id="nowTime" class="font-bold text-lg">--:--</span>
                </div>

                <label for="hoursToAdd" class="font-semibold text-gray-700">Horas a A√±adir:</label>
                <input type="number" id="hoursToAdd" value="10" class="input-field mb-4">
                
                <button id="calculateExpiry" class="btn-primary w-full py-3 rounded-lg font-bold text-lg">
                    Calcular Vccto.
                </button>
                
                <div class="mt-4 text-center">
                    <p class="text-gray-800 text-xl">Vence el:</p>
                    <p id="expiryTime" class="font-bold text-2xl text-gray-900">--/--/---- --:--</p>
                </div>
            </div>

        </div>

        <!-- NUEVA VISTA: R√ìTULO AUTOM√ÅTICO -->
        <div id="view-rotulo-auto" class="view-content hidden p-2 md:p-4">
            <div class="card overflow-x-auto">
                <h2 class="text-xl font-bold mb-4 text-gray-800">R√≥tulo Autom√°tico</h2>

                <div class="grid md:grid-cols-3 gap-4 mb-4">
                    <div class="md:col-span-1">
                        <label class="text-sm font-semibold text-gray-600">Producto</label>
                        <select id="ra-product" class="input-field">
                            <option value="">Seleccione un producto‚Ä¶</option>
                        </select>
                    </div>
                    <div class="md:col-span-2 flex items-end">
                        <span id="ra-load-status" class="text-xs text-gray-400">Cargando reglas‚Ä¶</span>
                    </div>
                </div>

                <!-- Tabla del r√≥tulo -->
                <div class="overflow-auto" id="ra-table-wrapper" style="display:none;">
                    <table class="min-w-[750px] w-full border border-gray-300 text-sm">
                        <tbody id="ra-table-body">
                            <!-- Fila 1: Item / FR / FV -->
                            <tr class="bg-gray-100">
                                <td class="border border-gray-300 px-2 py-2 font-semibold w-28">Item
                                    <div id="ra-item-name" class="text-[11px] text-gray-600 font-normal truncate"></div>
                                </td>
                                <td class="border border-gray-300 px-2 py-2 w-32">
                                    <label class="block text-[10px] uppercase tracking-wide text-gray-500">FR (manual)</label>
                                    <input id="ra-fr-date" type="date" class="w-full border rounded px-1 py-1 text-xs">
                                </td>
                                <td class="border border-gray-300 px-2 py-2 w-32">
                                    <label class="block text-[10px] uppercase tracking-wide text-gray-500">FV (calc)</label>
                                    <input id="ra-fv-date" type="date" class="w-full border rounded px-1 py-1 text-xs bg-gray-50" disabled>
                                </td>
                                <td class="border border-gray-300 px-2 py-2 w-24 text-center font-medium text-gray-500" colspan="3">
                                    Vida √∫til base (FV) seg√∫n reglas
                                </td>
                            </tr>
                            <!-- Fila 2: Encabezados -->
                            <tr class="bg-gray-50 text-gray-700 font-semibold">
                                <td class="border border-gray-300 px-2 py-1"></td>
                                <td class="border border-gray-300 px-2 py-1 text-center">Inic</td>
                                <td class="border border-gray-300 px-2 py-1 text-center">Fecha</td>
                                <td class="border border-gray-300 px-2 py-1 text-center">Hora</td>
                                <td class="border border-gray-300 px-2 py-1 text-center">F. Venc</td>
                                <td class="border border-gray-300 px-2 py-1 text-center">Hora Venc</td>
                            </tr>
                            <!-- Fila 3: Prep -->
                            <tr>
                                <td class="border border-gray-300 px-2 py-2 font-semibold">Prep</td>
                                <td class="border border-gray-300 px-1 py-1">
                                    <input id="ra-prep-code" placeholder="xx" class="w-full border rounded px-1 py-1 text-xs">
                                </td>
                                <td class="border border-gray-300 px-1 py-1">
                                    <input id="ra-prep-date" type="date" class="w-full border rounded px-1 py-1 text-xs">
                                </td>
                                <td class="border border-gray-300 px-1 py-1">
                                    <input id="ra-prep-time" type="time" class="w-full border rounded px-1 py-1 text-xs">
                                </td>
                                <td class="border border-gray-300 px-1 py-1">
                                    <input id="ra-prep-exp-date" type="date" class="w-full border rounded px-1 py-1 text-xs bg-gray-50" disabled>
                                </td>
                                <td class="border border-gray-300 px-1 py-1">
                                    <input id="ra-prep-exp-time" type="time" class="w-full border rounded px-1 py-1 text-xs bg-gray-50" disabled>
                                </td>
                            </tr>
                            <!-- Fila 4: Prod -->
                            <tr>
                                <td class="border border-gray-300 px-2 py-2 font-semibold">Prod</td>
                                <td class="border border-gray-300 px-1 py-1 text-center text-xs text-gray-400">‚Äî</td>
                                <td class="border border-gray-300 px-1 py-1">
                                    <input id="ra-prod-date" type="date" class="w-full border rounded px-1 py-1 text-xs">
                                </td>
                                <td class="border border-gray-300 px-1 py-1">
                                    <input id="ra-prod-time" type="time" class="w-full border rounded px-1 py-1 text-xs">
                                </td>
                                <td class="border border-gray-300 px-1 py-1">
                                    <input id="ra-prod-exp-date" type="date" class="w-full border rounded px-1 py-1 text-xs bg-gray-50" disabled>
                                </td>
                                <td class="border border-gray-300 px-1 py-1">
                                    <input id="ra-prod-exp-time" type="time" class="w-full border rounded px-1 py-1 text-xs bg-gray-50" disabled>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-4 text-xs space-y-1">
                    <p id="ra-notes" class="text-gray-600"></p>
                    <p id="ra-warnings" class="text-red-600 font-semibold"></p>
                </div>
            </div>
        </div>
        </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // ****** NUEVO C√ìDIGO JS PARA NAVEGACI√ìN DE PESTA√ëAS ******
            const navLinks = document.querySelectorAll('.nav-link');
            const views = document.querySelectorAll('.view-content');
            
            // Colores de la navbar
            const activeColor = '#006D56'; // Verde
            const inactiveColor = '#6B7280'; // Gris
            const activeBorderStyle = '4px solid #006D56';
            const inactiveBorderStyle = '4px solid transparent';

            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const viewIdToShow = link.dataset.view;

                    // 1. Ocultar todas las vistas
                    views.forEach(view => {
                        view.classList.add('hidden');
                    });

                    // 2. Mostrar la vista seleccionada
                    const viewToShow = document.getElementById(viewIdToShow);
                    if (viewToShow) {
                        viewToShow.classList.remove('hidden');
                    }

                    // 3. Actualizar estilos de los links
                    navLinks.forEach(navLink => {
                        navLink.style.color = inactiveColor;
                        navLink.style.borderBottom = inactiveBorderStyle;
                    });
                    
                    link.style.color = activeColor;
                    link.style.borderBottom = activeBorderStyle;
                });
            });
            // ****** FIN DEL C√ìDIGO DE NAVEGACI√ìN ******


            // --- Utilidades de Formato ---
            const formatCLP = (value) => {
                return new Intl.NumberFormat('es-CL', {
                    style: 'currency',
                    currency: 'CLP',
                    maximumFractionDigits: 0,
                    minimumFractionDigits: 0
                }).format(value);
            };

            const formatDate = (date) => {
                return date.toLocaleDateString('es-CL', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            };

            const formatTime = (date) => {
                return date.toLocaleTimeString('es-CL', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            const formatDateTime = (date) => {
                return `${formatDate(date)} ${formatTime(date)}`;
            };

            // --- 1. Calculadora de Descuentos Fijos ---
            const basePriceInput = document.getElementById('basePrice');
            const discountPercentages = [10, 20, 25, 30, 40, 50];

            basePriceInput.addEventListener('input', () => {
                const price = parseFloat(basePriceInput.value) || 0;
                discountPercentages.forEach(p => {
                    const finalPrice = price - (price * (p / 100));
                    const el = document.getElementById(`discount-${p}`);
                    if (el) el.textContent = formatCLP(finalPrice);
                });
            });

            // --- 2. Descuento sobre Descuento (Apilado) ---
            const stackedPriceInput = document.getElementById('stackedPrice');
            const stackedPercentInput = document.getElementById('stackedPercent');
            const applyStackedBtn = document.getElementById('applyStacked');
            const stackedCountEl = document.getElementById('stackedCount');
            const stackedTotalEl = document.getElementById('stackedTotal');
            let currentStackedPrice = 0;
            let stackedCount = 0;

            stackedPriceInput.addEventListener('input', () => {
                currentStackedPrice = parseFloat(stackedPriceInput.value) || 0;
                stackedCount = 0;
                stackedCountEl.textContent = stackedCount;
                stackedTotalEl.textContent = formatCLP(currentStackedPrice);
            });

            applyStackedBtn.addEventListener('click', () => {
                if (currentStackedPrice === 0) {
                     currentStackedPrice = parseFloat(stackedPriceInput.value) || 0;
                }
                const percent = parseFloat(stackedPercentInput.value) || 0;
                if (percent === 0) return;
                currentStackedPrice -= (currentStackedPrice * (percent / 100));
                stackedCount++;
                stackedCountEl.textContent = stackedCount;
                stackedTotalEl.textContent = formatCLP(currentStackedPrice);
            });

            // --- 3. Calculadora de R√≥tulos (D√≠as) ---
            const todayDateEl = document.getElementById('todayDate');
            const daysToCalculate = [3, 5, 10, 15, 30];
            const today = new Date();
            todayDateEl.textContent = formatDate(today);

            daysToCalculate.forEach(days => {
                const futureDate = new Date(today);
                futureDate.setDate(today.getDate() + days);
                const el = document.getElementById(`date-${days}`);
                if (el) el.textContent = formatDate(futureDate);
            });

            const customDaysInput = document.getElementById('customDays');
            const customDateResultEl = document.getElementById('customDateResult');

            customDaysInput.addEventListener('input', () => {
                const days = parseInt(customDaysInput.value) || 0;
                if (days <= 0) {
                    customDateResultEl.textContent = '--/--/----';
                    return;
                }
                const futureDate = new Date(today);
                futureDate.setDate(today.getDate() + days);
                customDateResultEl.textContent = formatDate(futureDate);
            });

            // --- 4. Calculadora de R√≥tulos (Horas) ---
            const nowTimeEl = document.getElementById('nowTime');
            const hoursToAddInput = document.getElementById('hoursToAdd');
            const calculateExpiryBtn = document.getElementById('calculateExpiry');
            const expiryTimeEl = document.getElementById('expiryTime');

            // Calcula la fecha de vencimiento basada en la hora actual + horas indicadas
            function computeExpiryDateFromNow() {
                const hours = parseInt(hoursToAddInput.value, 10) || 0;
                const d = new Date();
                d.setHours(d.getHours() + hours);
                return d;
            }

            // Actualiza el texto del vencimiento en la UI
            function updateExpiryDisplay() {
                const expiryDate = computeExpiryDateFromNow();
                expiryTimeEl.textContent = formatDateTime(expiryDate);
            }

            // Actualizar autom√°ticamente al cambiar el input y cuando se pulse el bot√≥n
            hoursToAddInput.addEventListener('input', updateExpiryDisplay);
            calculateExpiryBtn.addEventListener('click', updateExpiryDisplay);

            // Inicializar la visualizaci√≥n al cargar
            updateExpiryDisplay();
            nowTimeEl.textContent = formatTime(new Date());

            function renderTimers() {
                // actualizar la hora actual cada segundo (si el elemento existe)
                if (nowTimeEl) nowTimeEl.textContent = formatTime(new Date());
            }
            setInterval(renderTimers, 1000);

            /* === R√ìTULO AUTOM√ÅTICO TABLA (AUTO-CARGA DESDE SHEET) === */
            (function() {
                const productRules = {}; // { nombre: { pre: n, pro: n, fr: n } }
                const $ = id => document.getElementById(id);
                const statusEl = $('#ra-load-status');
                const productEl = $('#ra-product');
                const tableWrapper = $('#ra-table-wrapper');
                const itemNameEl = $('#ra-item-name');

                // FR/FV row
                const frDateEl = $('#ra-fr-date');
                const fvDateEl = $('#ra-fv-date');

                // Prep row
                const prepCodeEl = $('#ra-prep-code');
                const prepDateEl = $('#ra-prep-date');
                const prepTimeEl = $('#ra-prep-time');
                const prepExpDateEl = $('#ra-prep-exp-date');
                const prepExpTimeEl = $('#ra-prep-exp-time');

                // Prod row
                const prodDateEl = $('#ra-prod-date');
                const prodTimeEl = $('#ra-prod-time');
                const prodExpDateEl = $('#ra-prod-exp-date');
                const prodExpTimeEl = $('#ra-prod-exp-time');

                const notesEl = $('#ra-notes');
                const warnEl = $('#ra-warnings');

                const pad = n => String(n).padStart(2,'0');
                const toDateInput = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
                const toTimeInput = d => `${pad(d.getHours())}:${pad(d.getMinutes())}`;
                const endOfDay = d => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,0,0);
                const parseNum = (s) => {
                    const m = String(s||'').match(/-?\d+(?:[\.,]\d+)?/);
                    return m ? Number(m[0].replace(',', '.')) : NaN;
                };

                const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQa8hIhpn6I2Q-tciQQBP1n-KKYC_ZgcSK5PNIPf-QzNCOMpfXupgAtO3x5fwhaMt_tEybqF4jggLbj/pub?output=csv';

                function parseCSV(text) {
                    const lines = text.split(/\r?\n/).filter(l => l.trim());
                    if (!lines.length) return;
                    // Detectar separador ; , o tab
                    let sep = ',';
                    const first = lines[0];
                    if (first.includes('\t')) sep='\t'; else if (first.includes(';') && !first.includes(',')) sep=';';
                    const headerRaw = lines[0].split(sep).map(h => h.replace(/^"|"$/g,'').trim());
                    const header = headerRaw.map(h => h.toLowerCase());
                    const idxNombre = header.findIndex(h => /^(nombre|producto)$/i.test(h));
                    const idxPre    = header.findIndex(h => /(duracion\s*pre|pre$)/i.test(h));
                    const idxPro    = header.findIndex(h => /(duracion\s*prod|duracion\s*pro|prod$|pro$)/i.test(h));
                    const idxFr     = header.findIndex(h => /(duracion\s*fr|^fr$)/i.test(h));
                    lines.slice(1).forEach(line => {
                        const parts = line.split(sep).map(p => p.replace(/^\"|\"$/g,'').trim());
                        const nombre = idxNombre >= 0 ? parts[idxNombre] : '';
                        if (!nombre) return;
                        const preVal = idxPre >= 0 ? parts[idxPre] : '';
                        const proVal = idxPro >= 0 ? parts[idxPro] : '';
                        const frVal  = idxFr >= 0 ? parts[idxFr] : '';
                        const preNum = parseNum(preVal);
                        const proNum = parseNum(proVal);
                        const frNum  = parseNum(frVal);
                        if (Number.isFinite(preNum) && Number.isFinite(proNum)) {
                            productRules[nombre] = { pre: preNum, pro: proNum, fr: Number.isFinite(frNum) ? frNum : null };
                        }
                    });
                    refreshProductList();
                    const names = Object.keys(productRules);
                    const count = names.length;
                    statusEl.textContent = count ? `Productos cargados: ${names.join(', ')}` : 'No se encontraron productos.';
                    // Ocultar status luego de breve tiempo si exitoso
                    if (count) setTimeout(()=>{ statusEl.style.visibility='hidden'; }, 2000);
                }

                async function loadSheetAuto() {
                    const csvUrl = SHEET_CSV_URL;
                    if (statusEl) statusEl.textContent = 'Cargando...';
                    try {
                        const r = await fetch(csvUrl);
                        if (!r.ok) throw new Error('HTTP '+r.status);
                        const text = await r.text();
                        if (!text || text.length < 5) throw new Error('CSV vac√≠o');
                        parseCSV(text);
                        handleProductVisibility();
                    } catch (e) {
                        if (statusEl) statusEl.textContent = 'Error: ' + e.message;
                        console.error('Error cargando CSV:', e);
                    }
                }

                function refreshProductList() {
                    if (!productEl) return;
                    const prev = productEl.value;
                    productEl.innerHTML = '<option value="">Seleccione un producto‚Ä¶</option>';
                    Object.keys(productRules).sort().forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p;
                        opt.textContent = p;
                        productEl.appendChild(opt);
                    });
                    if (prev && productRules[prev]) productEl.value = prev;
                }

                function getDateTime(dateEl, timeEl) {
                    if (!dateEl.value) return null;
                    const time = timeEl && timeEl.value ? timeEl.value : '00:00';
                    const [hh, mm] = time.split(':').map(Number);
                    const d = new Date(dateEl.value);
                    d.setHours(hh||0, mm||0, 0, 0);
                    return d;
                }

                function addDaysClamp(start, days, fvClampDate) {
                    const target = new Date(start.getTime() + days*24*60*60*1000);
                    if (fvClampDate && target > fvClampDate) return fvClampDate;
                    return target;
                }

                function computeFVBase(product, frDate) {
                    if (!productRules[product] || !frDate) return null;
                    const rule = productRules[product];
                    const baseDays = (rule.fr !== null && rule.fr !== undefined) ? rule.fr : Math.max(rule.pre||0, rule.pro||0);
                    const fv = new Date(frDate.getTime() + baseDays*24*60*60*1000);
                    return endOfDay(fv); // se fija a 23:59
                }

                function clearOutputs() {
                    [prepExpDateEl, prepExpTimeEl, prodExpDateEl, prodExpTimeEl, fvDateEl].forEach(el => { if (el) el.value=''; });
                    notesEl.textContent='';
                    warnEl.textContent='';
                }

                function computeAll() {
                    warnEl.textContent = '';
                    notesEl.textContent = '';
                    const product = (productEl.value||'').trim();
                    if (!product || !productRules[product]) { clearOutputs(); return; }

                    const fr = frDateEl.value ? new Date(frDateEl.value) : null;
                    if (fr) fr.setHours(0,0,0,0);
                    const fvBase = fr ? computeFVBase(product, fr) : null;
                    if (fvBase) fvDateEl.value = toDateInput(fvBase);

                    // Prep
                    const prepStart = getDateTime(prepDateEl, prepTimeEl);
                    if (prepStart && fr && prepStart < fr) warnEl.textContent = 'Preparaci√≥n antes de FR.';
                    if (prepStart) {
                        const prepExpiry = addDaysClamp(prepStart, productRules[product].pre, fvBase);
                        prepExpDateEl.value = toDateInput(prepExpiry);
                        prepExpTimeEl.value = toTimeInput(prepExpiry);
                        if (fvBase && prepExpiry.getTime() === fvBase.getTime()) {
                            notesEl.textContent = 'Prep capado por FV.';
                        }
                    } else {
                        prepExpDateEl.value=''; prepExpTimeEl.value='';
                    }

                    // Prod
                    const prodStart = getDateTime(prodDateEl, prodTimeEl);
                    if (prodStart) {
                        const prodExpiry = addDaysClamp(prodStart, productRules[product].pro, fvBase);
                        prodExpDateEl.value = toDateInput(prodExpiry);
                        prodExpTimeEl.value = toTimeInput(prodExpiry);
                        if (fvBase && prodExpiry.getTime() === fvBase.getTime()) {
                            notesEl.textContent = (notesEl.textContent? notesEl.textContent+' ': '') + 'Prod capado por FV.';
                        }
                    } else {
                        prodExpDateEl.value=''; prodExpTimeEl.value='';
                    }
                }

                function initDefaults() {
                    const now = new Date();
                    const todayStr = toDateInput(now);
                    const timeStr = toTimeInput(now);
                    if (frDateEl && !frDateEl.value) frDateEl.value = todayStr;
                    if (prepDateEl && !prepDateEl.value) prepDateEl.value = todayStr;
                    if (prepTimeEl && !prepTimeEl.value) prepTimeEl.value = timeStr;
                    if (prodDateEl && !prodDateEl.value) prodDateEl.value = todayStr;
                    if (prodTimeEl && !prodTimeEl.value) prodTimeEl.value = timeStr;
                }

                function handleProductVisibility() {
                    const product = productEl.value.trim();
                    if (!product || !productRules[product]) {
                        if (tableWrapper) tableWrapper.style.display='none';
                        clearOutputs();
                        return;
                    }
                    if (tableWrapper) tableWrapper.style.display='block';
                    computeAll();
                }

                ['input','change'].forEach(ev => {
                    [productEl, frDateEl, prepDateEl, prepTimeEl, prodDateEl, prodTimeEl].forEach(el => el && el.addEventListener(ev, () => {
                        if (el === productEl) {
                            if (itemNameEl) itemNameEl.textContent = productEl.value || '';
                            handleProductVisibility();
                        } else {
                            computeAll();
                        }
                    }));
                });

                // Auto-carga al iniciar (sin mostrar controles de carga)
                loadSheetAuto();
                initDefaults();
            })();
            /* === FIN R√ìTULO AUTOM√ÅTICO TABLA === */
        });
    </script>
</body>
</html>

